---
title: "Jack's Working Patterns"
author: "Jumping Rivers Ltd"
date: "`r format(Sys.Date(), '%b %d %Y')`"
output: jrIdentity::readthedown
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

## By default reticulate creates virtualenvs in ~/.virtualenv
## To change where the virtualenv is created we have to use
## the WORKON_HOME environment variable
Sys.setenv(WORKON_HOME = ".")

## Create the virtualenv
reticulate::virtualenv_install(
  envname = "venv",
  python = Sys.which("python3.8"),
  packages = c("google", "gcsa", "pandas", "matplotlib", "numpy")
)

## Activate the virtualenv
reticulate::use_virtualenv("./venv")
Sys.setenv("RETICULATE_PYTHON" = file.path("./venv", "bin", "python"))
```

```{python imports, echo=FALSE}
from datetime import date, timedelta
from google.oauth2.credentials import Credentials
from gcsa.google_calendar import GoogleCalendar
import matplotlib.pyplot as plt
from matplotlib.ticker import MaxNLocator
import numpy as np
import os
import pandas as pd
```

```{python python-backend, echo=FALSE}
class GCalClocked():

    def __init__(self):
        self.creds = self.__get_creds()
        self.end = date.today()
        self.start = self.end - timedelta(days=90)
        self.events = self.__get_clock_df()
        self.status = "Clocked On" if self.events.iloc[-1]["clocked_off"] is None else "Clocked Off"

    def __get_creds(self):
        """Fetch credentials from env to authenticate against calendar."""
        return Credentials(token=os.environ["TOKEN"],
                           refresh_token=os.environ["REFRESH_TOKEN"],
                           client_id=os.environ["ID"],
                           client_secret=os.environ["SECRET"],
                           token_uri="https://oauth2.googleapis.com/token")

    def __get_clock_events(self):
        """Fetch calendar events with 'clocked' in title."""
        calendar = GoogleCalendar(credentials=self.creds)
        return calendar.get_events(time_min=self.start,
                                   time_max=self.end,
                                   query="clocked")

    def __get_clock_df(self):
        """Construct pandas DataFrame of clock on / clock off events."""
        # Create DataFrame from gcsa events
        events = pd.DataFrame([{"time": event.start,
                                "event": event.summary}
                              for event in self.__get_clock_events()])

        # Preallocate dataframe for transformed data
        df = pd.DataFrame({"clocked_on": None,
                           "clocked_off": None},
                           index=events["time"].dt.date.unique())

        # Loop over entries and add to correct position in transformed df
        for i, row in events.iterrows():
            clock_type = "clocked_on" if "on" in row["event"].lower() else "clocked_off"
            df.loc[row["time"].date(), clock_type] = row["time"].time()

        # Compute hours worked from clocked on and clocked off data
        df["hours_worked"] = (
            pd.to_datetime(df["clocked_off"].dropna().astype(str), format='%H:%M:%S')
            - pd.to_datetime(df["clocked_on"].dropna().astype(str), format='%H:%M:%S')
        ).dt.seconds / (60 ** 2)

        return df

    def get_last_days(self, last_days=90):
        return self.events.dropna().iloc[-last_days:]

    def summary(self, days=90, dp=2, agg=None):
        if agg is None:
            agg = {"sum": np.sum,
                   "mean": np.mean,
                   "min": np.min,
                   "max": np.max}
        return self.get_last_days(days)["hours_worked"].agg(agg).round(dp)

    def plot_days(self, days=90):
        ax = self.get_last_days(days)["hours_worked"].plot(kind="hist")
        ax.yaxis.set_major_locator(MaxNLocator(integer=True))
        ax.set_xlabel("Hours worked")
        ax.set_ylabel("Frequency")
        return ax.get_figure(), ax
```

```{python echo=FALSE}
plt.style.use("ggplot")
data = GCalClocked()
```

```{python echo=FALSE, results='asis'}
print(f"Current Status: {data.status}")
```

## Last 5 days

```{python echo=FALSE, results='asis'}
days = 5
summary = data.summary(days)
print(f"### Total Hours Worked: {summary['sum']} Hours")
print(f"### Average Working Day: {summary['mean']} Hours")
print(f"### Shortest Working Day: {summary['min']} Hours")
print(f"### Longest Working Day: {summary['max']} Hours")
```

## Last 30 days

```{python echo=FALSE, results='asis'}
days = 30
summary = data.summary(days)
print(f"### Total Hours Worked: {summary['sum']} Hours")
print(f"### Average Working Day: {summary['mean']} Hours")
print(f"### Shortest Working Day: {summary['min']} Hours")
print(f"### Longest Working Day: {summary['max']} Hours")
```

```{python echo=FALSE}
fig, ax = data.plot_days(days)
plt.show()
```

## Last 90 days

```{python echo=FALSE, results='asis'}
days = 90
summary = data.summary(days)
print(f"### Total Hours Worked: {summary['sum']} Hours")
print(f"### Average Working Day: {summary['mean']} Hours")
print(f"### Shortest Working Day: {summary['min']} Hours")
print(f"### Longest Working Day: {summary['max']} Hours")
```

```{python echo=FALSE}
fig, ax = data.plot_days(days)
plt.show()
```
